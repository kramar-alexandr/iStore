external procedure AddToCreditorsAccounts(string,Integer,val,Array string,Array val,var Integer);external procedure PrintAPTotals(string,val,val,val,val);external procedure PrintCreditorsAccounts(Array string,Array val,var Integer);external function Boolean APRPrintOverView(record VIVc,record RcVc,val,val,LongInt);external procedure SumAgedInstalmenVI(Date,LongInt,var val,var val,var val,var val,var val,var val,var val,var val);external function Integer TypeOfCurncy(var string,var Integer);external function val MulRateToBase2(var string,val,val,val,val,val,val,Integer);external function val MulRateToBase1(var string,val,val,val,val,val,val,Integer);external function val MulWithRateToBase2(var string,Date,val,Integer);external function val MulWithRateToBase1(var string,Date,val,Integer);external function LongInt DateDiff(Date,Date);external procedure PrintPrepaymentsNrsOP(record RcVc,string,Boolean);external procedure PrintPrepaymentsNrsOPMy(record RcVc,string,Boolean,var val,var val);external procedure PrintHeaderAP1(string,string,record RcVc);external procedure PrintHeaderAP2(record RcVc,Integer); external procedure SumAged(Date,Integer,var val,var val,var val,var val,var val,var val,var val,var val,var val);external procedure APGetOnAccBalance(record RcVc,record CUVc,Boolean,var val,var val,var val,var val,var val,var val,var val);external function Boolean APWithLogg2(record RcVc,record VIVc,var val,var val,Integer,Boolean);external procedure PrintAgedLine(val,val,val,val,val,val,val,val,val,Integer,Integer);external procedure CountPeriods(var Integer);external procedure SubAPPrePayments(record VIVc,var val,var val);external procedure GetAPInvBalance(record VIVc,Date,Integer,var val,var val,var LongInt);external procedure Base1ToBase2(var val,Date,var val);external function Boolean SetInSet2(string,string);external procedure ClassTypef(string,string,var Boolean);external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);// Edit ************************** Thursday, 26 January 2012 12:28:50globalprocedure APRn(record RcVc RepSpec)BEGIN  record APVc APr;  record CUVc VEr;  record VIVc VIr;  Boolean TrHs,VendOut,VEs;  Boolean backdatf,testf,testf2,firstf,first2f,foundclosed;  string 255 tstr;  string 255 frve,tove;  string 255 ckey;  LongInt latedays,keys;  Integer rwcnt,nrofper;  val AP1Sum,CurSum,totSum,AP2Sum;  val s0,s1,s2,s3,s4,s5,s6,s7;  val s0b2,s1b2,s2b2,s3b2,s4b2,s5b2,s6b2,s7b2;  val ss0,ss1,ss2,ss3,ss4,ss5,ss6,ss7;  val ss0b2,ss1b2,ss2b2,ss3b2,ss4b2,ss5b2,ss6b2,ss7b2;  val rs,rs2,rval;  val sum,sum2,tot,totb2,t2;  val due1tot,Total1due,due2tot,Total2due,notdue1tot,Total1notdue,notdue2tot,Total2notdue,TotOnAcc;  val sumdiff,sumbooked,sumnow,sumcurncy;  val totdiff,totbooked,totnow;  record BaseCurBlock bascur;  val tot2Sum,tot1Sum;  val vt;  Date thedate,curdate;  Boolean vifoundf;  Array string 10 credaccs;  Array val credbal;  Integer credcnt;  val onaccsumbooked,onaccsumnow,onaccsumcurncy,onaccsumdiff;  Integer oldstyle;  record AgedBlock Ab;  val myrs,myrsval;// Edit ************************** Wednesday, 29 February 2012 14:34:49  val fr,to1,to2,br1,br2;    BlockLoad(Ab);    credcnt = -1;  curdate = CurrentDate;  BlockLoad(bascur);  foundclosed = false;  thedate = RepSpec.d1;  if (BlankDate(thedate)) then begin    if ((RepSpec.flags[3]!=0) or (RepSpec.flags[5]!=0)) then begin      thedate = CurrentDate;    end;  end;  if (blankdate(thedate)) then begin    backdatf = false;  end else begin    backdatf = true;  end;    frve = FirstInRange(RepSpec.f1,20);  tove = LastInRange(RepSpec.f1,20);  // Edit Start ---------------------------------------------- Edit Start	//Wednesday, 18 July 2012 09:55:21	  if(currentcompany==5 and currentuser=="YULIYA")then begin    if(frve!="EUROTEX" and frve!="MELNIK")then begin      frve="EUROTEX";      tove="EUROTEX";    end;    if(nonblank(tove))then begin      tove = frve;    end;  end;  	// Edit End ---------------------------------------------- Edit End	  StartReportJob(USetStr(4041));    PrintHeaderAP1(frve,tove,RepSpec);     EndHeader;  CountPeriods(nrofper);/* Old      SetRepCol(2,230);      SetRepCol(3,290);      SetRepCol(4,330);      SetRepCol(5,380);      The rest to 430*/  if (RepSpec.ArtMode==2) then begin  if (nrofper==2) then begin    SetRepCol(2,250);    SetRepCol(3,300);    SetRepCol(4,350);    SetRepCol(5,400);  end;  if (nrofper==3) then begin    SetRepCol(2,240);    SetRepCol(3,280);    SetRepCol(4,320);    SetRepCol(5,360);    SetRepCol(6,400);  end;  if (nrofper==4) then begin    SetRepCol(2,230);    SetRepCol(3,263);    SetRepCol(4,296);    SetRepCol(5,329);    SetRepCol(6,362);    SetRepCol(7,395);  end;  if (nrofper==5) then begin    SetRepCol(2,220);    SetRepCol(3,249);    SetRepCol(4,278);    SetRepCol(5,307);    SetRepCol(6,336);    SetRepCol(7,365);    SetRepCol(8,394);  end;  if (nrofper==6) then begin    SetRepCol(2,210);    SetRepCol(3,235);    SetRepCol(4,260);    SetRepCol(5,285);    SetRepCol(6,310);    SetRepCol(7,335);    SetRepCol(8,360);    SetRepCol(9,385);  end;  end;  PrintHeaderAP2(RepSpec,nrofper);  if (RepSpec.flags[1]==1) then begin    VEr.Name = frve;    ckey = "Name";    VEs = LoopKey(ckey,VEr,1,true);//VEs = m4_ReadFirstLCKey(CUVc,ckey,&VEr,1,false,&LLoop2);    keys = 1;    firstf = true;  end else begin    if (blank(RepSpec.f3)) then begin      VEr.Code = frve;      ckey = "Code";      VEs = LoopKey(ckey,VEr,1,true);//VEs = m4_ReadFirstLMain(CUVc,&VEr,1,false,&LLoop2);      keys = 1;      firstf = true;    end else begin      VEr.VECat = RepSpec.f3;      VEr.Code = frve;      ckey = "VECat";      VEs = LoopKey(ckey,VEr,2,true);//VEs = m4_ReadFirstLCKey(CUVc,ckey,&VEr,2,false,&LLoop2);      keys = 2;      firstf = true;    end;  end;L22:;  if (VEs==false) then begin goto L88; end;    if (firstf) then begin       firstf = false;       ResetLoop(VEr);          end;    VEs = LoopKey(ckey,VEr,keys,true);//VEs = m4_ReadLogicalCKey(CUVc,ckey,LLoop2++,&VEr);    testf2 = true;    if (VEr.VEType==0) then begin testf2 = false; end;    if (VEs) then begin      if (RepSpec.flags[1]==1) then begin        if (nonblank(tove)) then begin          if (VEr.Name>tove) then begin            VEs = false;          end;        end;          end else begin        if (nonblank(tove)) then begin          if (VEr.Code>tove) then begin            VEs = false;          end;        end;          end;      if (nonblank(RepSpec.f3)) then begin        if (VEr.VECat<>RepSpec.f3) then begin          testf2 = false;        end;      end;         if (nonblank(RepSpec.f4)) then begin        if (SetInSet2(RepSpec.f4,VEr.Classification)==false) then begin          testf2 = false;        end;      end;      if (nonblank(RepSpec.f5)) then begin        if (testf2) then begin          testf2 = false;          ClassTypef(RepSpec.f5,VEr.Classification,testf2);        end;      end;    end;    // Edit Start ---------------------------------------------- Edit Start	//Wednesday, 15 June 2011 13:20:31	if(currentcompany == 2)then	begin    	if((currentuser=="SHEVCHUK") or (currentuser=="MAKAROV"))then begin       		if(VEr.Code!="AIAIAI_IPOINT" and VEr.Code!="DUBLON_IPOINT" and VEr.Code!="SMOBILE_IPOINT" 									and VEr.Code!="iCenter"   and VEr.Code!="ICENTER_E"  and VEr.Code!="IBEST"  									and VEr.Code!="ISTORE"    and VEr.Code!="RADIOLINE"  and VEr.Code!="SB_1995" 									and VEr.Code!="PRESTIGE"  and VEr.Code!="SRV" and VEr.Code!="ICENTER_SHOPS" 									and VEr.Code!="JP" 		  and VEr.Code!="OFI" and VEr.Code!="OFI_E" 									and VEr.Code!="OFI_SHOPS" and VEr.Code!="ORION" and VEr.Code!="SE" 									and VEr.Code!="TECHNOPORT" and VEr.Code!="MEGABITE" and VEr.Code!="TAXAFON" 									and VEr.Code!="UG-KONTRAKT" and VEr.Code!="UG-KONTRAKT_P") 				//*Edit by Victor. Add client.       		then 			   begin					VEs=false;  			   end;    end;    end;    	// Edit End ---------------------------------------------- Edit End	    if (VEs==false) then begin goto L88; end;  if (testf2==false) then begin goto L22; end;  VendOut = false;    CurSum = 0;  AP1Sum = 0;  AP2Sum = 0;  s0 = 0; s0b2 = 0;  s1 = 0; s1b2 = 0;  s2 = 0; s2b2 = 0;  s3 = 0; s3b2 = 0;  s4 = 0; s4b2 = 0;  s5 = 0; s5b2 = 0;  s6 = 0; s6b2 = 0;  s7 = 0; s7b2 = 0;  rwcnt = 0;  if (RepSpec.flags[2]==1) then begin    s0 = CurSum + s0;  end else begin    s0 = AP1Sum + s0;  end;    if (backdatf) then begin    VIr.VECode = VEr.Code;    VIr.SerNr = 0;        first2f = true;    ResetLoop(VIr);    TrHs = LoopKey("VECode",VIr,2,true);//TrHs = m4_ReadFirstLCKey(VIVc,"VECode",&VIr,2,false,&LLoop1);  end else begin    APr.VECode = VEr.Code;    APr.SerNr = 0;    first2f = true;    ResetLoop(APr);    TrHs = LoopKey("VECode",APr,2,true);//TrHs = m4_ReadFirstLCKey(APVc,"VECode",&APr,2,false,&LLoop1);  end;    if (RepSpec.flags[21]==1) then begin TrHs = false; end;  while (TrHs==true) begin    testf = false;    if (backdatf) then begin      if (first2f) then begin        first2f = false;        ResetLoop(VIr);      end;      TrHs = LoopKey("VECode",VIr,2,true);//TrHs = m4_ReadLogicalCKey(VIVc,"VECode",LLoop1++,&VIr);      if (TrHs) then begin        if (VEr.Code<>VIr.VECode) then begin TrHs = false; end;      end;        if (TrHs) then begin        testf = true;        if (RepSpec.flags[22]==0) then begin          latedays = DateDiff(VIr.DueDate,thedate);        end else begin          latedays = DateDiff(VIr.InvDate,thedate);        end;            if ((RepSpec.flags[0]<>0) and (latedays>=0)) then begin testf = false; end;        if (VIr.TransDate>thedate) then begin testf = false; end;//        if (VIr.InvType==2) then begin testf = false; end;//moed down        if (VIr.Invalid<>0) then begin testf = false; end;        if (RepSpec.flags[3]==0) then begin          if (VIr.OKFlag==0) then begin testf = false; end;        end;          if (RepSpec.flags[23]!=0) then begin          if (VIr.Closed!=0) then begin testf = false; end;        end;                if ((nonblank(RepSpec.f3)) and (RepSpec.f3<>VEr.VECat)) then begin testf = false; end;        if ((nonblank(RepSpec.AccStr)) and (RepSpec.AccStr<>VIr.SalesMan)) then begin testf = false; end;//        if ((nonblank(RepSpec.f2)) and (RepSpec.f2<>VEr.SalesGroup)) then begin testf = false; end;//Invoice has salesgroup        if ((nonblank(RepSpec.ObjStr)) and (SetInSet(RepSpec.ObjStr,VIr.Objects)==false)) then begin testf = false; end;        if (nonblank(RepSpec.Language)) then begin          if (RepSpec.Language!=VIr.LangCode) then begin            testf = false;          end;        end;        if (nonblank(RepSpec.FirstAcc)) then begin          if (RepSpec.FirstAcc!=VIr.APAcc) then begin            testf = false;          end;        end;        if (nonblank(RepSpec.f2)) then begin          if (VIr.SalesGroup<>RepSpec.f2) then begin            testf = false;          end;        end;                  if (nonblank(RepSpec.CurncyCode)) then begin          if (VIr.CurncyCode!=RepSpec.CurncyCode) then begin                      testf = false;          end;        end;        if (testf) then begin          if (VIr.InvType==3) then begin            if (VIr.CredInv==-1) then begin              rval = 0-VIr.PayVal;            end else begin              rval = 0;            end;          end else begin            rval = VIr.PayVal;          end;          if (VIr.InvType==kInvoiceTypeCash) then begin            rval = blankval;          end;          rs = MulRateToBase1(VIr.CurncyCode,rval,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);          GetAPInvBalance(VIr,thedate,RepSpec.flags[14],rval,rs,latedays);          SubAPPrePayments(VIr,rval,rs);          rs = rs - VIr.WithHoldingTax;          Base1ToBase2(rs,VIr.TransDate,rs2); /* wierd *///          rs = MulRateToBase1(VIr.CurncyCode,rval,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff); //          rs2 = MulRateToBase2(VIr.CurncyCode,rval,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);          if (rval==0) then begin testf = false; end;          if (testf) then begin            if (latedays<0) then begin              due1tot = due1tot + rs;              due2tot = due2tot + rs2;            end else begin              notdue1tot = notdue1tot + rs;              notdue2tot = notdue2tot + rs2;            end;          end;          end;      end;    end else begin      if (first2f) then begin        first2f = false;        ResetLoop(APr);      end;      TrHs = LoopKey("VECode",APr,2,true);//TrHs = m4_ReadLogicalCKey(APVc,"VECode",LLoop1++,&APr);      if (TrHs) then begin        if (VEr.Code<>APr.VECode) then begin TrHs = false; end;      end;        if (TrHs) then begin        if (RepSpec.flags[22]==0) then begin          latedays = DateDiff(APr.DueDate,curdate);        end else begin          VIr.SerNr = APr.SerNr;          vifoundf = ReadFirstMain(VIr,1,true);          latedays = DateDiff(VIr.InvDate,curdate);        end;            if ((RepSpec.flags[0]==0) or (latedays<0)) then begin          if ((blank(RepSpec.f3)) or (RepSpec.f3==VEr.VECat)) then begin            testf = true;          end;        end;      end;//      if ((nonblank(RepSpec.f2)) and (RepSpec.f2<>VEr.SalesGroup)) then begin testf = false; end;//Invoice has salesgroup      if (testf) then begin        VIr.SerNr = APr.SerNr;        vifoundf = ReadFirstMain(VIr,1,true);        if ((nonblank(RepSpec.AccStr)) and (RepSpec.AccStr<>VIr.SalesMan)) then begin testf = false; end;        if ((nonblank(RepSpec.ObjStr)) and (SetInSet(RepSpec.ObjStr,VIr.Objects)==false)) then begin testf = false; end;        if ((nonblank(RepSpec.f2)) and (RepSpec.f2<>VIr.SalesGroup)) then begin testf = false; end;        if (nonblank(RepSpec.FirstAcc)) then begin          if (RepSpec.FirstAcc!=VIr.APAcc) then begin            testf = false;          end;        end;        if (nonblank(RepSpec.Language)) then begin          if (RepSpec.Language!=VIr.LangCode) then begin            testf = false;          end;        end;        if (RepSpec.flags[23]!=0) then begin          if (VIr.Closed!=0) then begin testf = false; end;        end;              end;      if (nonblank(RepSpec.CurncyCode)) then begin        if (APr.CurncyCode!=RepSpec.CurncyCode) then begin                    testf = false;        end;      end;      if (testf) then begin        rval = APr.RVal;                VIr.SerNr = APr.SerNr;        if (vifoundf) then begin          if (RepSpec.flags[22]==0) then begin            latedays = DateDiff(VIr.DueDate,curdate);          end else begin            latedays = DateDiff(VIr.InvDate,curdate);          end;               if (RepSpec.flags[2]==1) then begin             rval = APr.RVal;             rs = MulRateToBase1(VIr.CurncyCode,rval,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);                                    rs2 = MulRateToBase2(VIr.CurncyCode,rval,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);           end else begin             rval = APr.BookRVal;             rs = APr.BookRVal;             rs2 = MulRateToBase2(VIr.CurncyCode,APr.RVal,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);                        end;          end else begin           if (RepSpec.flags[2]==1) then begin             rs = APr.RVal;             rs2 = MulRateToBase2(VIr.CurncyCode,APr.RVal,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);           end else begin             rs = APr.BookRVal;             rs2 = MulWithRateToBase2(APr.CurncyCode,curdate,APr.RVal,DefaultCurRoundOff);           end;             VIr.VECode = APr.VECode;           VIr.VEName = VEr.Name;           VIr.SerNr = APr.SerNr;           VIr.InvDate = APr.DueDate;           VIr.CurncyCode = APr.CurncyCode;        end;        if (latedays<0) then begin          due1tot = due1tot + rs;          due2tot = due2tot + rs2;        end else begin          notdue1tot = notdue1tot + rs;          notdue2tot = notdue2tot + rs2;        end;      end;    end;    if (testf) then begin        if ((VendOut==false) and (RepSpec.ArtMode!=3) and (RepSpec.ArtMode!=4) and (RepSpec.ArtMode!=6) and (RepSpec.ArtMode!=2)) then begin          Gray_Divider(0,1);          if(RepSpec.Media!=20 and RepSpec.Media!=2)then begin            StartFormat(15);// Edit ************************** Thursday, 26 January 2012 11:02:07            OutString(0,"DblCUVc",VEr.Code,false);            OutString(100,0,VEr.Name,false);            OutString(280,0,VEr.Phone,false);            if (RepSpec.flags[2]==1) then begin              OutString(480,0,VEr.VECurncyCode,true);            end;              EndFormat;/// Edit ************************** Thursday, 26 January 2012 11:02:08          end;          VendOut = true;        end;        AP1Sum = AP1Sum + rs;        AP2Sum = AP2Sum + rs2;        CurSum = CurSum + rval;        rwcnt = rwcnt + 1;        if ((RepSpec.flags[18]!=0) and (RepSpec.ArtMode!=4) and (RepSpec.ArtMode!=6)) then begin          AddToCreditorsAccounts(VIr.APAcc,VIr.InvType,rs,credaccs,credbal,credcnt);        end;                if (RepSpec.ArtMode==0) then begin// Historik           foundclosed = APWithLogg2(RepSpec,VIr,rval,rs,rwcnt,backdatf);        end;        if (RepSpec.ArtMode==1) then begin// Overview                     // Edit Start ---------------------------------------------- Edit Start	//Wednesday, 29 February 2012 12:30:02          if(RepSpec.Media==20 or RepSpec.Media==2)then begin              foundclosed = APRPrintOverView(VIr,RepSpec,rval,rs,latedays);// Edit ************************** Wednesday, 29 February 2012 14:26:25// Edit ************************** Wednesday, 29 February 2012 14:26:27                            myrsval = myrsval + rval;              myrs = myrs + rs;              vt = vt + rs;              if(latedays<0)then begin                totSum = totSum + rs;                if(oldstyle>latedays)then begin                  oldstyle=latedays;                end;              end;              if(nonblank(VEr.VECurncyCode) and (VEr.VECurncyCode!=VIr.CurncyCode))then begin                //GetFullCurncyRate(VEr.VECurncyCode,VIr.InvDate,fr,to1,to2,br1,br2);                //VIr.CurncyCode,rval,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2                myrsval = myrsval + rs*VIr.FrRate/VIr.ToRateB1;              end;                        end else begin            foundclosed = APRPrintOverView(VIr,RepSpec,rval,rs,latedays);              end;          	// Edit End ---------------------------------------------- Edit End	//          AddCurncyTotals(acur,av1,curcnt,IVr.CurncyCode,rval);        end;        if (RepSpec.ArtMode==2) then begin// Aged          if ((VIr.InstallmentInv==1) and (RepSpec.flags[19]!=0)) then begin            if (RepSpec.flags[2]==0) then begin              SumAgedInstalmenVI(curdate,VIr.SerNr,s0,s1,s2,s3,s4,s5,s6,s7);            end else begin              if (nonblank(VEr.VECurncyCode)) then begin                SumAgedInstalmenVI(curdate,VIr.SerNr,s0,s1,s2,s3,s4,s5,s6,s7);              end else begin                SumAgedInstalmenVI(curdate,VIr.SerNr,s0,s1,s2,s3,s4,s5,s6,s7);              end;            end;          end else begin            if (RepSpec.flags[2]==0) then begin              SumAged(thedate,latedays,rs,s0,s1,s2,s3,s4,s5,s6,s7);              SumAged(thedate,latedays,rs2,s0b2,s1b2,s2b2,s3b2,s4b2,s5b2,s6b2,s7b2);            end else begin              if (nonblank(VEr.VECurncyCode)) then begin                SumAged(thedate,latedays,rval,s0,s1,s2,s3,s4,s5,s6,s7);              end else begin                SumAged(thedate,latedays,rs,s0,s1,s2,s3,s4,s5,s6,s7);                SumAged(thedate,latedays,rs2,s0b2,s1b2,s2b2,s3b2,s4b2,s5b2,s6b2,s7b2);              end;            end;          end;        end;        if (RepSpec.ArtMode==3) then begin// Saldo                     end;        if (RepSpec.ArtMode==4) then begin// rate difference                        sumbooked = sumbooked + rs;          if (backdatf) then begin            t2 = MulWithRateToBase1(VIr.CurncyCode,thedate,rval,DefaultCurRoundOff);                    end else begin            t2 = MulWithRateToBase1(VIr.CurncyCode,curdate,APr.RVal,DefaultCurRoundOff);          end;              sumnow = sumnow + t2;          if (backdatf) then begin            sumcurncy = sumcurncy + rval;          end else begin            sumcurncy = sumcurncy + APr.RVal;          end;          t2 = t2 - rs;          sumdiff = sumdiff + t2;        end;        if (RepSpec.ArtMode==6) then begin// rate difference detailed          sumbooked = sumbooked + rs;          if (backdatf) then begin            t2 = MulWithRateToBase1(VIr.CurncyCode,thedate,rval,DefaultCurRoundOff);          end else begin            t2 = MulWithRateToBase1(VIr.CurncyCode,curdate,APr.RVal,DefaultCurRoundOff);          end;              sumnow = sumnow + t2;          if (backdatf) then begin            sumcurncy = sumcurncy + rval;          end else begin            sumcurncy = sumcurncy + APr.RVal;          end;          if ((t2 - rs)<>0) then begin            if (VendOut==false) then begin              StartFormat(15);               OutString(0,"DblCUVc",VEr.Code,false);               OutString(100,0,VEr.Name,false);               if (RepSpec.flags[2]==1) then begin                OutString(480,0,VEr.VECurncyCode,true);               end;                EndFormat;              VendOut = true;            end;                      StartFormat(15);             OutString(0,"DblVIVc",VIr.SerNr,false);             if (backdatf) then begin               OutVal(260,0,rval,M4Val,true);             end else begin               OutVal(260,0,APr.RVal,M4Val,true);             end;             OutVal(320,0,t2,M4Val,true);             OutVal(400,0,rs,M4Val,true);             OutVal(480,0,t2 - rs,M4Val,true);            EndFormat;                    end;          t2 = t2 - rs;          sumdiff = sumdiff + t2;        end;L55:;    end;  end;//find out onaccount receipts  rval = 0;  if (RepSpec.flags[21]<2) then begin        APGetOnAccBalance(RepSpec,VEr,backdatf,sum,sum2,rval,onaccsumbooked,onaccsumnow,onaccsumcurncy,onaccsumdiff);    sumbooked = sumbooked - onaccsumbooked;    sumnow = sumnow - onaccsumnow;    sumcurncy = sumcurncy - onaccsumcurncy;    sumdiff = sumdiff + onaccsumdiff;    TotOnAcc = TotOnAcc - sum;    if (RepSpec.ArtMode==6) then begin      if (onaccsumdiff<>0) then begin        StartFormat(15);        OutString(50,0,USetStr(2497),false);        OutVal(260,0,onaccsumcurncy,M4Val,true);        OutVal(320,0,onaccsumnow,M4Val,true);        OutVal(400,0,onaccsumbooked,M4Val,true);        OutVal(480,0,onaccsumdiff,M4Val,true);        EndFormat;      end;    end;  end;  if (rval==0) then begin    sum = 0;  end;  AP1Sum = AP1Sum + sum;  AP2Sum = AP2Sum + sum2;  CurSum = CurSum + rval;  if (RepSpec.ArtMode==0) then begin    if (sum<>0) then begin      if ((VendOut==false) and (RepSpec.ArtMode<>3) and (RepSpec.ArtMode<>4)) then begin        Gray_Divider(0,1);        StartFormat(15);        OutString(0,"DblCUVc",VEr.Code,false);        OutString(100,0,VEr.Name,false);        OutString(280,0,VEr.Phone,false);        if (RepSpec.flags[2]==1) then begin          OutString(480,0,VEr.VECurncyCode,true);        end;          EndFormat;        VendOut = true;      end;      StartFormat(15);      OutString(50,0,USetStr(2497),false);      if (RepSpec.flags[2]==1) then begin        OutVal(480,0,rval,M4Val,true);      end else begin        OutVal(480,0,sum,M4Val,true);      end;      EndFormat;      if (RepSpec.flags[13]!=0) then begin        PrintPrepaymentsNrsOP(RepSpec,VEr.Code,backdatf);      end;                end;  end;  if (RepSpec.ArtMode==1) then begin    if (sum<>0) then begin      if ((VendOut==false) and (RepSpec.ArtMode<>3) and (RepSpec.ArtMode<>4)) then begin        Gray_Divider(0,1);        // Edit Start ---------------------------------------------- Edit Start	//Friday, 27 January 2012 16:00:03        if(RepSpec.Media!=20 and RepSpec.Media!=2)then begin          StartFormat(15);          OutString(0,"DblCUVc",VEr.Code,false);          OutString(100,0,VEr.Name,false);          OutString(280,0,VEr.Phone,false);          if (RepSpec.flags[2]==1) then begin            OutString(480,0,VEr.VECurncyCode,true);          end;            EndFormat;        end;	// Edit End ---------------------------------------------- Edit End	        VendOut = true;      end;      if(RepSpec.Media!=20 and RepSpec.Media!=2)then begin        StartFormat(15);// Edit ************************** Thursday, 26 January 2012 11:43:01        OutString(140,0,USetStr(2497),false);// Edit ************************** Thursday, 26 January 2012 11:34:52        if (RepSpec.flags[2]==1) then begin          OutVal(480,0,rval,M4Val,true);        end else begin          OutVal(480,0,sum,M4Val,true);        end;        EndFormat;// Edit ************************** Thursday, 26 January 2012 11:43:02      end;      if (RepSpec.flags[13]!=0) then begin        // Edit Start ---------------------------------------------- Edit Start	//Wednesday, 29 February 2012 13:22:18	        if((RepSpec.Media==20 or RepSpec.Media==2))then begin            //RepSpec.vals0  = 0;            //RepSpec.vals1  = 0;            PrintPrepaymentsNrsOPMy(RepSpec,VEr.Code,backdatf,myrsval,myrs);// Edit ************************** Wednesday, 29 February 2012 14:26:39// Edit ************************** Wednesday, 29 February 2012 14:26:40            //myrsval = myrsval + RepSpec.vals0;            //myrs = myrs + RepSpec.vals1;                    end else begin          PrintPrepaymentsNrsOP(RepSpec,VEr.Code,backdatf);            end;      end;                end;  end;    if (RepSpec.ArtMode==4) then begin    if (sumdiff<>0) then begin      StartFormat(15);      OutString(0,"DblCUVc",VEr.Code,false);      OutString(60,0,VEr.Name,false);      OutVal(260,0,sumcurncy,M4Val,true);      OutVal(320,0,sumnow,M4Val,true);      OutVal(400,0,sumbooked,M4Val,true);      OutVal(480,0,sumdiff,M4Val,true);      EndFormat;      totdiff = totdiff + sumdiff;      totbooked = totbooked + sumbooked;      totnow = totnow + sumnow;    end;  end;  if (RepSpec.ArtMode==6) then begin    if (sumdiff<>0) then begin      Gray_Divider(200,1);      StartFormat(15);      OutVal(260,0,sumcurncy,M4Val,true);      OutVal(320,0,sumnow,M4Val,true);      OutVal(400,0,sumbooked,M4Val,true);      OutVal(480,0,sumdiff,M4Val,true);      EndFormat;      totdiff = totdiff + sumdiff;      totbooked = totbooked + sumbooked;      totnow = totnow + sumnow;    end;  end;  if (RepSpec.ArtMode==2) then begin    testf = true;    if ((s0==0) and (s1==0) and (s2==0) and (s3==0) and  (s4==0) and  (s5==0) and (s6==0) and (s7==0) and (sum==0)) then begin      testf = false;    end;      if (testf) then begin      if (RepSpec.flags[2]==1) then begin        s0 = s0 + rval;      end else begin        s0 = s0 + sum;      end;        tot = s0 + s1;      tot = tot + s2;      tot = tot + s3;      tot = tot + s4;      tot = tot + s5;      tot = tot + s6;      tot = tot + s7;      StartFormat(15);      OutString(0,"DblCUVc",VEr.Code,false);      OutString(70,0,VEr.Name,false);      if (RepSpec.flags[2]==1) then begin        PrintAgedLine(s0,s1,s2,s3,s4,s5,s6,s7,tot,nrofper,464);        OutString(465,0,VEr.VECurncyCode,false);      end else begin        PrintAgedLine(s0,s1,s2,s3,s4,s5,s6,s7,tot,nrofper,480);      end;      EndFormat;    end;  end;  if (RepSpec.ArtMode==0) then begin    if (VendOut==true) then begin      Black_Divider(400,480);      if (RepSpec.flags[2]==1) then begin        if (nonblank(VEr.VECurncyCode)) then begin          StartFormat(15);          OutString(320,0,2424,true);          OutString(360,0,VEr.VECurncyCode,false);          OutVal(480,0,CurSum,M4Val,true);          EndFormat;        end;      end;      StartFormat(15);      OutString(380,0,USetStr(4047),true);      OutVal(480,0,AP1Sum,M4Val,true);      EndFormat;      Total1due = Total1due + due1tot;      Total2due = Total2due + due2tot;            Total1notdue = Total1notdue + notdue1tot;      Total2notdue = Total2notdue + notdue2tot;          end;  end;  // Edit Start ---------------------------------------------- Edit Start	//Thursday, 1 March 2012 11:10:28	  if(RepSpec.ArtMode==1 and (RepSpec.Media==20 or RepSpec.Media==2))then begin       // custcodetemp1 = custcodetemp;   // custcodetemp = VIr.VECode;        if(myrsval!=0)then begin            startformat(15);        Outstring(0,0,VEr.Code,false);        Outstring(0,0,USetStr(2424),false);        if(nonblank(VEr.VECurncyCode))then begin          OutString(360,0,VEr.VECurncyCode,false);          Outstring(0,0,myrsval,false);        end else begin          OutString(360,0,bascur.BaseCur1,false);          Outstring(0,0,myrs,false);        end;      endformat;      /*if(nonblank(VEr.VECurncyCode) and VEr.VECurncyCode!=bascur.BaseCur1)then begin        startformat(15);          Outstring(0,0,VEr.Code,false);                                                  //Yбери также поле - Ѓаланс EURO - это поле евро эквивалента// Edit ************************** Friday, 17 August 2012 14:22:15          Outstring(0,0,USetStr(2424) & " " & bascur.BaseCur1,false);          Outstring(0,0,myrs,false);        endformat;      end;*/      if(oldstyle<0)then begin        if(totSum==vt)then begin          startformat(15);            Outstring(0,0,USetStr(4060),false);            Outstring(0,0,myrs,false);            Outstring(0,0,oldstyle,false);          endformat;        end else begin          startformat(15);            Outstring(0,0,USetStr(4052),false);            Outstring(0,0,totSum,false);            Outstring(0,0,oldstyle,false);          endformat;          startformat(15);            Outstring(0,0,USetStr(4051),false);            Outstring(0,0,vt-totSum,false);          endformat;        end;      end;            startformat(15);      endformat;      myrsval = 0;      myrs = 0;      totSum = 0;      oldstyle = 0;      vt = 0;          end;  end;  	// Edit End ---------------------------------------------- Edit End	    if (RepSpec.ArtMode==1 and myrsval!=0) then begin// Edit ************************** Wednesday, 29 February 2012 12:09:48    if (VendOut==true) then begin      Black_Divider(400,480);      if (RepSpec.flags[2]==1) then begin        if (nonblank(VEr.VECurncyCode)) then begin          StartFormat(15);          OutString(320,0,USetStr(2424),true);          OutString(360,0,VEr.VECurncyCode,false);          OutVal(480,0,CurSum,M4Val,true);          EndFormat;        end;      end;      StartFormat(15);      OutString(320,0,USetStr(4047),true);      OutVal(480,0,AP1Sum,M4Val,true);      EndFormat;      if (due1tot<>0) then begin        StartFormat(15);        OutString(320,0,USetStr(4060),true);        OutVal(480,0,due1tot,M4Val,true);        EndFormat;        Total1due = Total1due + due1tot;        Total2due = Total2due + due2tot;                    end;            if (notdue1tot<>0) then begin        StartFormat(15);        OutString(320,0,USetStr(4051),true);        OutVal(480,0,notdue1tot,M4Val,true);        EndFormat;        Total1notdue = Total1notdue + notdue1tot;        Total2notdue = Total2notdue + notdue2tot;                    end;          end;  end;  if (RepSpec.ArtMode==2) then begin    if (VendOut==true) then begin      Black_Divider(400,480);      StartFormat(15);       OutVal(480,0,AP1Sum,M4Val,true);      EndFormat;    end;    Total1due = Total1due + due1tot;    Total2due = Total2due + due2tot;                        Total1notdue = Total1notdue + notdue1tot;    Total2notdue = Total2notdue + notdue2tot;                      end;  if (RepSpec.ArtMode==3) then begin    if (RepSpec.flags[2]==0) then begin      if (AP1Sum==0) then begin goto L77; end;    end;       if (RepSpec.flags[2]==1) then begin      if (CurSum==0) then begin goto L77; end;    end;      StartFormat(15);    OutString(0,"DblCUVc",VEr.Code,false);    OutString(100,0,VEr.Name,false);    if (RepSpec.flags[2]==1) then begin      if (blank(VEr.VECurncyCode)) then begin        OutVal(480,0,AP1Sum,M4Val,true);      end else begin      OutString(320,0,VEr.VECurncyCode,false);        OutVal(480,0,CurSum,M4Val,true);      end;    end else begin      OutVal(480,0,AP1Sum,M4Val,true);    end;      EndFormat;    Total1due = Total1due + due1tot;    Total2due = Total2due + due2tot;                      Total1notdue = Total1notdue + notdue1tot;    Total2notdue = Total2notdue + notdue2tot;                    end;  L77:;  due1tot = 0;  due2tot = 0;  notdue1tot = 0;  notdue2tot = 0;  tot1Sum = AP1Sum + tot1Sum;  tot2Sum = AP2Sum + tot2Sum;  ss0 = ss0 + s0;  ss1 = ss1 + s1;  ss2 = ss2 + s2;  ss3 = ss3 + s3;  ss4 = ss4 + s4;  ss5 = ss5 + s5;  ss6 = ss6 + s6;  ss7 = ss7 + s7;  ss0b2 = ss0b2 + s0b2;  ss1b2 = ss1b2 + s1b2;  ss2b2 = ss2b2 + s2b2;  ss3b2 = ss3b2 + s3b2;  ss4b2 = ss4b2 + s4b2;  ss5b2 = ss5b2 + s5b2;  ss6b2 = ss6b2 + s6b2;  ss7b2 = ss7b2 + s7b2;  sumcurncy = 0;  sumdiff = 0;  sumbooked = 0;  sumnow = 0;    /*startformat(15);  endformat;*/    goto L22;L88:;  Gray_Divider(0,1);  if (RepSpec.ArtMode==2) then begin    tot = ss0 + ss1;    tot = tot + ss2;    tot = tot + ss3;    tot = tot + ss4;    tot = tot + ss5;    tot = tot + ss6;    tot = tot + ss7;    totb2 = ss0b2 + ss1b2;    totb2 = ss2b2 + totb2;    totb2 = ss3b2 + totb2;    totb2 = ss4b2 + totb2;    totb2 = ss5b2 + totb2;    totb2 = ss6b2 + totb2;    totb2 = ss7b2 + totb2;    StartFormat(15);     PrintAgedLine(ss0,ss1,ss2,ss3,ss4,ss5,ss6,ss7,tot,nrofper,480)    EndFormat;    if (RepSpec.flags[12]!=0) then begin      StartFormat(15);      PrintAgedLine(ss0b2,ss1b2,ss2b2,ss3b2,ss4b2,ss5b2,ss6b2,ss7b2,totb2,nrofper,480)      EndFormat;    end;  end;  if ((RepSpec.flags[2]==1) and (RepSpec.ArtMode==3)) then begin goto L99; end;  if ((RepSpec.flags[2]==1) and (RepSpec.ArtMode==2)) then begin goto L99; end;  if (RepSpec.ArtMode<>4) and (RepSpec.ArtMode<>6 and RepSpec.Media!=2 and RepSpec.Media!=20 and RepSpec.Media!=2) then begin    PrintAPTotals(bascur.BaseCur1,tot1Sum,Total1due,Total1notdue,TotOnAcc);    if ((bascur.BaseCur1<>bascur.BaseCur2) and (RepSpec.flags[12]==1)) then begin      Gray_Divider(290,1);      PrintAPTotals(bascur.BaseCur2,tot2Sum,Total2due,Total2notdue,blankval);    end;  end;/*      if (RepSpec.ArtMode!=4) then begin    StartFormat(15);    OutString(380,0,USetStr(4048),true);    OutVal(480,0,totSum,M4Val,true);    EndFormat;    if (RepSpec.ArtMode==1) then begin    StartFormat(15);    OutString(380,0,USetStr(4060),true);    OutVal(480,0,Totaldue,M4Val,true);    EndFormat;    end;  end;*/    if (RepSpec.ArtMode==4) or (RepSpec.ArtMode==6) then begin    StartFormat(15);    OutVal(320,0,totnow,M4Val,true);    OutVal(400,0,totbooked,M4Val,true);    OutVal(480,0,totdiff,M4Val,true);    EndFormat;  end;  if ((RepSpec.flags[18]!=0) and (RepSpec.ArtMode!=4) and RepSpec.ArtMode!=6) then begin    PrintCreditorsAccounts(credaccs,credbal,credcnt);  end;L99:;  if (foundclosed and (RepSpec.ArtMode<>4) and (RepSpec.ArtMode<>6)) then begin    StartFormat(15);    OutString(50,0,USetStr(1225),false);    EndFormat;  end;  EndJob;L999:;  RETURN;END;